<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Cursos</title>
    <link rel="stylesheet" href="style.css">
</head>
<!-- BOT√ÉO DO CHAT -->
<button id="chatBtn">Chat</button>
<div id= "avatarImg">
    <img id="avatarMascote" src="imagem/Vitoruga.png">
</div>


<!-- JANELA DO CHAT -->
<div id="chatWindow">
    <div id="chatHeader">
  Atendimento
  <button id="muteToggle" style="float:right; background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer;">
      üîä
  </button>
</div>


    <div id="chatBody"></div>

    <div id="chatInputWrap">
        <input id="chatInput" type="text" placeholder="Digite sua mensagem...">
        <button id="chatSend">Enviar</button>
    </div>
</div>

<body>

<header class="banner">
    <div class="stats-container">
        <div class="stat-box">
            <span class="numero">0</span>
            <p>vagas hoje</p>
        </div>

        <img src="imagem/VIxcursos.png" class="logo-ativa" alt="Logo">

        <div class="stat-box">
            <span class="numero">2.518</span>
            <p>vagas em 2025</p>
        </div>
    </div>
</header>

<section class="filtros-card">

    <div class="filtro-item">
        <label>Idade:</label>
        <select id="filtro-idade"></select>
    </div>

    <div class="filtro-item">
        <label>Categoria:</label>
        <select id="filtro-categoria"></select>
    </div>

    <div class="filtro-item">
        <label>Modalidade:</label>
        <select id="filtro-modalidade"></select>
    </div>

    <div class="filtro-item">
        <label>Local:</label>
        <select id="filtro-local"></select>
    </div>

</section>

<div class="banner-botoes">
    <a href="informacoes.html" class="btn-tema btn-claro">Sobre o Projeto</a>
    <a href="https://www.vitoria.es.gov.br" target="_blank" class="btn-tema btn-escuro">
        Prefeitura de Vit√≥ria
    </a>
</div>

<table class="tabela-cursos">
    <thead>
        <tr>
            <th>Faixa Et√°ria</th>
            <th>Nome curso</th>
            <th>Dura√ß√£o</th>
            <th>Hor√°rio</th>
            <th>Local</th>
            <th>Detalhes</th>
            <th>Situa√ß√£o</th>
            <th>Vagas</th>
            <th>Aberto</th>
        </tr>
    </thead>

    <tbody id="listaCursos"></tbody>
</table>
<a href="https://aistudio.google.com/apps/drive/1ljMEupKmhNpmd0Ke1WtZSYTw9g8GIUOf?showPreview=true&showAssistant=true" target="_blank" class="btn-whatsapp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
</a>

<footer class="rodape">
    <div class="rodape-conteudo">

        <div class="rodape-coluna">
            <img src="imagem/VIxcursos.png" class="logo-rodape" alt="Logo Vix Cursos">
            <p>O portal que conecta VOC√ä √†s melhores oportunidades de cursos gratuitos.</p>
        </div>

        <div class="rodape-coluna">
            <h4>Siga-nos</h4>
            <div class="social">
                <a href="#">üìò</a>
                <a href="#">üì∏</a>
                <a href="#">‚ñ∂Ô∏è</a>
                <a href="admin/menu.html">üíº</a>
            </div>
        </div>

    </div>

    <div class="rodape-copy">
        ¬© 2025 Vix Cursos. Todos os direitos reservados.
    </div>
</footer>

<!-- ====================================================== -->
<!-- LISTAGEM DE CURSOS                                    -->
<!-- ====================================================== -->
<script>
async function carregarCursos() {
    try {
        const res = await fetch("http://localhost:3000/cursos");

        if (!res.ok) {
            console.error("Erro no servidor:", res.status);
            return;
        }

        const cursos = await res.json();
        const tbody = document.getElementById("listaCursos");
        tbody.innerHTML = "";

        if (!Array.isArray(cursos) || cursos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; padding:10px;">
                        Nenhum curso dispon√≠vel no momento.
                    </td>
                </tr>
            `;
            return;
        }

        cursos.forEach(curso => {
            const faixa = `${curso.idade_min || '-'} a ${curso.idade_max || '-'}`;
            const duracao = curso.duracao || "Indefinida";
            const horario = curso.horario || "Consultar";
            const vagas = curso.vagas ?? "0";

            tbody.innerHTML += `
                <tr>
                    <td data-label="Faixa Et√°ria">${faixa}</td>
                    <td data-label="Nome">${curso.nome}</td>
                    <td data-label="Dura√ß√£o">${duracao}</td>
                    <td data-label="Hor√°rio">${horario}</td>
                    <td data-label="Local">${curso.local || 'N√£o informado'}</td>

                    <td data-label="Detalhes">
                        <button class="btn-saiba">Saiba +</button>
                    </td>

                    <td data-label="Situa√ß√£o">
                        ${
                            curso.vagas > 0
                            ? `<button class="btn-inscricao" onclick="window.location.href='pre_inscricao.html?id=${curso.id}'">Pr√©-inscri√ß√£o</button>`
                            : `<button class="btn-inscricao btn-desativado" disabled>ESGOTADO</button>`
                        }
                    </td>

                    <td data-label="Vagas" class="col-vagas ${curso.vagas <= 0 ? 'texto-vermelho' : ''}">
                        ${curso.vagas}
                    </td>

                    <td data-label="Aberto" class="${curso.status === 'esgotado' ? 'col-esgotado' : 'col-aberto'}">
                        ${curso.status === 'esgotado' ? '0' : '1'}
                    </td>
                </tr>
            `;
        });

    } catch (err) {
        console.error("Erro ao carregar cursos:", err);
    }
}
carregarCursos();
</script>

<!-- ====================================================== -->
<!-- FILTROS                                                -->
<!-- ====================================================== -->
<script>
async function carregarFiltros() {

    // IDADE
    let r1 = await fetch("http://localhost:3000/public/idade");
    let idades = await r1.json();
    let selIdade = document.querySelector("#filtro-idade");
    selIdade.innerHTML = '<option value="">Todas</option>';
    idades.forEach(i => selIdade.innerHTML += `<option>${i.idade}</option>`);

    // CATEGORIA
    let r2 = await fetch("http://localhost:3000/public/categoria");
    let categorias = await r2.json();
    let selCategoria = document.querySelector("#filtro-categoria");
    selCategoria.innerHTML = '<option value="">Todas</option>';
    categorias.forEach(c => selCategoria.innerHTML += `<option>${c.categoria}</option>`);

    // MODALIDADE
    let r3 = await fetch("http://localhost:3000/public/modalidade");
    let modalidades = await r3.json();
    let selModal = document.querySelector("#filtro-modalidade");
    selModal.innerHTML = '<option value="">Todas</option>';
    modalidades.forEach(m => selModal.innerHTML += `<option>${m.modalidade}</option>`);

    // LOCAL
    let r4 = await fetch("http://localhost:3000/public/local");
    let locais = await r4.json();
    let selLocal = document.querySelector("#filtro-local");
    selLocal.innerHTML = '<option value="">Todos</option>';
    locais.forEach(l => selLocal.innerHTML += `<option>${l.local}</option>`);
}
carregarFiltros();
</script>

<!-- ====================================================== -->
<!-- INSCRI√á√ÉO                                              -->
<!-- ====================================================== -->
<script>
async function inscrever(curso_id) {
    const nome = prompt("Seu nome:");
    const email = prompt("Seu email:");
    const telefone = prompt("Seu telefone:");

    const res = await fetch("http://localhost:3000/inscricao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, email, telefone, curso_id })
    });

    const resposta = await res.json();
    alert(resposta.status || resposta.error);
}
</script>

<!-- ====================================================== -->
<!-- CHAT WIDGET                                            -->
<!-- ====================================================== -->
<style>
#chatBtn {
  position: fixed; right: 20px; bottom: 20px;
  background:#0aa; color:#fff; border:none; padding:12px 16px;
  border-radius:50px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.2);
}
#chatWindow {
  position: fixed; right:20px; bottom:80px;
  width:320px; max-height:60vh; background:#fff;
  border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
  display:none; overflow:hidden; font-family:Arial;
}
#chatHeader { background:#0aa; color:#fff; padding:10px; }
#chatBody { padding:10px; height:40vh; overflow:auto; }
.chat-msg { margin:8px 0; }
.chat-msg.user { text-align:right; }
.chat-msg .bubble {
  display:inline-block; padding:8px 12px; border-radius:12px; max-width:80%;
}
.chat-msg.user .bubble { background:#0aa; color:#fff; }
.chat-msg.bot .bubble { background:#f1f1f1; color:#111; }
#chatInputWrap { display:flex; border-top:1px solid #eee; }
#chatInput { flex:1; border:0; padding:10px; }
#chatSend { border:0; background:#0aa; color:#fff; padding:10px 12px; cursor:pointer; }
</style>

<script>
async function inscrever(curso_id) {
    const nome = prompt("Seu nome:");
    const email = prompt("Seu email:");
    const telefone = prompt("Seu telefone:");

    const res = await fetch("http://localhost:3000/inscricao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, email, telefone, curso_id })
    });

    const resposta = await res.json();
    alert(resposta.status || resposta.error);
}
</script>

<style>
/* chat */
#chatBtn {
  position: fixed; right: 20px; bottom: 20px;
  background:#0aa; color:#fff; border:none; padding:12px 16px;
  border-radius:50px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.2);
  z-index: 10000;
}
#chatWindow {
  position: fixed; right:20px; bottom:80px;
  width:320px; max-height:60vh; background:#fff;
  border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
  display:none; overflow:hidden; font-family:Arial; z-index:10001;
}
#chatHeader { background:#0aa; color:#fff; padding:10px; position:relative; }
#muteToggle { position:absolute; right:10px; top:6px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer; }
#chatBody { padding:10px; height:40vh; overflow:auto; background:#fafafa; }
.chat-msg { margin:8px 0; }
.chat-msg.user { text-align:right; }
.chat-msg .bubble {
  display:inline-block; padding:8px 12px; border-radius:12px; max-width:80%;
}
.chat-msg.user .bubble { background:#0aa; color:#fff; }
.chat-msg.bot .bubble { background:#f1f1f1; color:#111; }
#chatInputWrap { display:flex; border-top:1px solid #eee; }
#chatInput { flex:1; border:0; padding:10px; }
#chatSend { border:0; background:#0aa; color:#fff; padding:10px 12px; cursor:pointer; }

/* avatar bubble */
#avatarImg {
    position: fixed;
    right: 360px;
    bottom: 40px;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border: 3px solid #1eff00;
    z-index: 10000;
    transition: transform 0.18s, box-shadow 0.18s;
}
#avatarImg img { width: 55px; height:55px; border-radius:50%; }
#avatarImg.talking { transform: scale(1.08); box-shadow: 0 0 20px rgba(0,195,255,0.8); }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const chatBtn = document.getElementById('chatBtn');
  const chatWindow = document.getElementById('chatWindow');
  const chatBody = document.getElementById('chatBody');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const muteToggle = document.getElementById('muteToggle');
  const avatarBubble = document.getElementById('avatarBubble');

  let muted = false;
  let avatarTimeout = null;

  // abrir/fechar chat
  chatBtn.addEventListener('click', () => {
    const open = chatWindow.style.display === 'block';
    chatWindow.style.display = open ? 'none' : 'block';
    chatWindow.setAttribute('aria-hidden', open ? 'true' : 'false');
    if (!open) chatInput.focus();
  });

  // TTS respeitando mute
  function speak(text) {
  if (muted || !text.trim()) return;

  if (speechSynthesis.speaking) speechSynthesis.cancel();

  let t = text;

  // Remove HTML
  t = t.replace(/<[^>]+>/g, "");

  // Remove markdown
  t = t.replace(/[*_~`]/g, "");

  // Remove emojis
  t = t.replace(
    /([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF][\uDC00-\uDFFF])/g,
    ""
  );

  // Substitui s√≠mbolos por fala
  t = t
    .replace(/üìò/g, "") // √≠cone de livro
    .replace(/üìç/g, "Local: ")
    .replace(/üë•/g, "vagas: ")
    .replace(/üëâ/g, "")
    .replace(/üöÄ/g, "")
    .replace(/‚Äî/g, " - ")
    .replace(/\s+/g, " ") // limpa espa√ßos extras
    .trim();

  const utter = new SpeechSynthesisUtterance(t);
  utter.lang = "pt-BR";
  utter.rate = 1;
  utter.pitch = 1;
  utter.volume = 1;

  utter.onstart = startAvatarTalking;
  utter.onend = stopAvatarTalking;

  speechSynthesis.speak(utter);
}



  // anima√ß√£o do avatar
  function startAvatarTalking() {
    if (!avatarBubble) return;
    clearTimeout(avatarTimeout);
    avatarBubble.classList.add('talking');
  }

  function stopAvatarTalking() {
    if (!avatarBubble) return;
    clearTimeout(avatarTimeout);
    avatarBubble.classList.remove('talking');
  }

  // mute
  if (muteToggle) {
    muteToggle.addEventListener('click', () => {
      muted = !muted;
      muteToggle.textContent = muted ? 'üîá' : 'üîä';
      muteToggle.setAttribute('aria-pressed', muted);

      if (muted && speechSynthesis.speaking) speechSynthesis.cancel();
    });
  }

  // adiciona mensagens
  function addMessage(who, htmlText) {
    const div = document.createElement('div');
    div.className = `chat-msg ${who === 'user' ? 'user' : 'bot'}`;

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    // melhora o regex do bot√£o
    const text = htmlText.replace(
      /(https?:\/\/[^\s]*pre_inscricao\.html\?id=\d+|pre_inscricao\.html\?id=\d+)/g,
      `<a href="$1" style="background:#0aa;color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:bold;display:block;margin-top:6px;">üöÄ Fazer Pr√©-inscri√ß√£o</a>`
    );

    bubble.innerHTML = text;
    div.appendChild(bubble);
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;

    if (who === 'bot') {
      speak(text.replace(/<[^>]*>?/gm, ''));
    }
  }

  // enviar mensagem
  async function enviarMensagem() {
    const text = chatInput.value.trim();
    if (!text) return;

    addMessage('user', text);
    chatInput.value = '';

    addMessage('bot', '‚è≥ Respondendo...');

    // resposta local para "inscri√ß√£o"
    if (/inscri|inscrever|matricul|pre[- ]?inscri/i.test(text)) {
      chatBody.querySelector('.chat-msg.bot:last-child')?.remove();

      addMessage('bot', `
        Claro! Clique no bot√£o abaixo para fazer sua pr√©-inscri√ß√£o:
        <br><br>
        <a href="pre_inscricao.html" style="background:#0aa;color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:bold;display:inline-block;">Fazer Pr√©-inscri√ß√£o</a>
      `);
      return;
    }

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });

      const data = await res.json();

      chatBody.querySelector('.chat-msg.bot:last-child')?.remove();

      const respostaFiltrada = filtrarCursos(data.reply, text);
      addMessage('bot', respostaFiltrada);

    } catch (err) {
      chatBody.querySelector('.chat-msg.bot:last-child')?.remove();
      addMessage('bot', 'Erro ao enviar. Tente novamente.');
    }
  }

  chatSend.addEventListener('click', enviarMensagem);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') enviarMensagem();
  });

  if (avatarBubble) {
    avatarBubble.addEventListener('click', () => {
      chatWindow.style.display = 'block';
      chatInput.focus();
    });
  }
});
function removerEmojis(texto) {
  return texto.replace(
    /([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF][\uDC00-\uDFFF])/g,
    ""
  ).trim();
}
// Dicion√°rio de cursos + abrevia√ß√µes/sin√¥nimos
const mapaCursos = {
  "administra√ß√£o": ["adm", "admin", "administracao"],
  "artesanato": ["artes", "artesan"],
  "automa√ß√£o industrial": ["auto", "automacao", "industrial", "automa"],
  "beleza": ["estetica", "beleza"],
  "cinema": ["cine"],
  "com√©rcio / gest√£o empresarial": ["comercio", "gestao", "empresarial", "gest"],
  "confec√ß√£o": ["confeccao", "confec"],
  "constru√ß√£o civil / servi√ßo": ["construcao", "civil", "servico", "obra"],
  "cultura": ["cultur"],
  "dan√ßa": ["danca"],
  "dan√ßa e teatro": ["teatro", "danca"],
  "educa√ß√£o": ["educa"],
  "eletr√¥nica": ["eletron", "eletronica"],
  "eletricista / energia": ["eletric", "energia"],
  "enfermagem / sa√∫de": ["enf", "enfermagem", "saude"],
  "est√©tica": ["estetica"],
  "eventos": ["event"],
  "fotografia": ["foto", "fotografia"],
  "gastronomia": ["gastro", "cozinha"],
  "gest√£o": ["gestao", "gest"],
  "idiomas": ["idioma", "ingles", "espanhol", "frances"],
  "inform√°tica / tecnologia": ["info", "informatica", "tec", "tecnologia", "ti"],
  "log√≠stica": ["log", "logistica"],
  "manuten√ß√£o": ["manutencao", "manu"],
  "mec√¢nica": ["mec", "mecanica"],
  "meio ambiente": ["ambiente", "meio"],
  "moda": ["moda", "fashion"],
  "m√∫sica": ["mus", "musica"],
  "panifica√ß√£o / confeitaria": ["pani", "pao", "confeitaria"],
  "produ√ß√£o cultural": ["producao", "cultural"],
  "programa√ß√£o / ti": ["programacao", "programar", "prog", "dev", "codigo", "ti"],
  "recursos humanos": ["rh", "recurso", "humanos"],
  "redes / telecom": ["redes", "telecom", "net", "wifi", "rede"],
  "seguran√ßa do trabalho": ["seg", "seguranca", "trabalho", "sst"],
  "servi√ßo social": ["servico", "social", "ss"],
  "soldagem": ["solda", "sold"],
  "turismo / hotelaria": ["tur", "turismo", "hotelaria", "hotel"],
  "vendas / marketing": ["vendas", "marketing", "mkt"]
};

function filtrarCursos(respostaBruta, textoUsuario) {
  const normalizar = t =>
    removerEmojis(t).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const user = normalizar(textoUsuario);

  // extrair termo
  let termo = user
    .replace(/curso(s)?\s*(de)?\s*/g, "")
    .trim();

  if (!termo) return respostaBruta;

  const termoNorm = normalizar(termo);

  // montar lista de sin√¥nimos e abrevia√ß√µes
  const sinonimos = [];

  for (const nome in mapaCursos) {
    const nomeNorm = normalizar(nome);
    sinonimos.push({ nome, nomeNorm, keys: mapaCursos[nome].map(normalizar) });
  }

  // identificar cursos que correspondem ao termo
  const cursosDetectados = sinonimos.filter(c => {
    if (c.nomeNorm.includes(termoNorm) || termoNorm.includes(c.nomeNorm)) return true;
    if (c.keys.some(k => k.startsWith(termoNorm))) return true;
    if (c.keys.some(k => termoNorm.startsWith(k))) return true;
    return false;
  });

  if (cursosDetectados.length === 0) {
    return `Nenhum curso encontrado para "${termo}".`;
  }

  // separar em blocos pelo üìò
  const blocos = respostaBruta
    .split(/üìò/g)
    .map(b => b.trim())
    .filter(b => b.length > 5)
    .map(b => "üìò " + b);

  const resultados = [];

  for (const bloco of blocos) {
    const blocoNorm = normalizar(bloco);

    if (cursosDetectados.some(c => blocoNorm.includes(c.nomeNorm))) {
      resultados.push(bloco);
    }
  }

  if (resultados.length === 0) {
    return `Curso encontrado, mas nenhum resultado dispon√≠vel no momento.`;
  }

  return `
üìö <b>${resultados.length}</b> curso(s) encontrado(s) relacionado(s) a <b>${termo}</b>:
<br><br>
${resultados.join("<br><br>")}
  `;
}

</script>
<script>
// ============================
//     AVATAR DO CHATBOT
// ============================
const avatarImg = document.getElementById("avatarImg");

// avatar padr√£o
const avatarPadrao = "imagem/Vitoruga.png";

// mapa de imagens do avatar por curso
const avatarCursos = {
  gastronomia: "imagem/Vitoruga gastron√¥mica.png",
  culinaria: "imagem/Vitoruga gastron√¥mica.png",
  cozinha: "imagem/Vitoruga gastron√¥mica.png",

  artesanato: "imagem/Vitoruga artes√£.png",
  artesanal: "imagem/Vitoruga artes√£.png",

  metalurgia: "imagem/Vitoruga metalurgica.png",
  mecanica: "imagem/Vitoruga metalurgica.png",
  soldagem: "imagem/Vitoruga metalurgica.png",
  solda: "imagem/Vitoruga metalurgica.png",

  construcao: "imagem/Vitoruga constru√ß√£o civil.png",
  pedreiro: "imagem/Vitoruga constru√ß√£o civil.png",
  obra: "imagem/Vitoruga constru√ß√£o civil.png",
  civil: "imagem/Vitoruga constru√ß√£o civil.png",
};

// normalizar texto
function normalizarAvatar(t) {
  return t
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

// ======== TROCAR AVATAR SOMENTE SE FOR FILTRO DE CURSOS ========
function atualizarAvatarSeCurso(texto) {
  const t = normalizarAvatar(texto);

  // s√≥ troca avatar se o texto mencionar "curso"
  if (!t.includes("curso") && !t.includes("cursos")) {
    avatarImg.src = avatarPadrao;
    return;
  }

  // remove prefixo "curso de ..."
  let termo = t.replace(/curso(s)?( de)?/g, "").trim();

  if (!termo) {
    avatarImg.src = avatarPadrao;
    return;
  }

  // procura curso relacionado
  for (const key in avatarCursos) {
    if (termo.includes(key)) {
      avatarImg.src = avatarCursos[key];
      return;
    }
  }

  // se n√£o encontrou o curso digitado ‚Üí volta ao normal
  avatarImg.src = avatarPadrao;
}

// Atualiza avatar enquanto o usu√°rio DIGITA
document.getElementById("chatInput").addEventListener("input", e => {
  atualizarAvatarSeCurso(e.target.value);
});

// Atualiza avatar depois que ele ENVIA a mensagem
function enviarMensagem() {
  const texto = chatInput.value.trim();

  atualizarAvatarSeCurso(texto);

  // ... resto do seu c√≥digo original ...
}

</script>





</body>
</html>
